<!DOCTYPE html>
<html lang="en">
<head>
    <title>Display Thing Panel</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <meta name="darkreader-lock">
    <meta charset="utf-8">
    <style>
        :root {
            /* Catppuccin Macchiato */
            --rosewater: #f4dbd6;
            --flamingo: #f0c6c6;
            --pink: #f5bde6;
            --mauve: #c6a0f6;
            --red: #ed8796;
            --maroon: #ee99a0;
            --peach: #f5a97f;
            --yellow: #eed49f;
            --green: #a6da95;
            --teal: #8bd5ca;
            --sky: #91d7e3;
            --sapphire: #7dc4e4;
            --blue: #8aadf4;
            --lavender: #b7bdf8;
            --text: #cad3f5;
            --subtext1: #b8c0e0;
            --subtext0: #a5adce;
            --overlay2: #939ab7;
            --surface2: #6e738d;
            --surface1: #5b6078;
            --surface0: #494d64;
            --base: #24273a;
            --mantle: #1e2030;
            --crust: #181926;
        }

        html {
            box-sizing: border-box;
        }

        *,
        *:before,
        *:after {
            box-sizing: inherit;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--base);
            color: var(--text);
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin: 5vh auto;
            background-color: var(--mantle);
            padding: 2rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            width: 90%;
            min-width: 320px;
            max-width: 500px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: var(--mauve);
            text-align: center;
            margin-top: 0;
            margin-bottom: 2rem;
        }

        h2 {
            color: var(--sapphire);
            margin-bottom: 2rem;
        }

        .page-description {
            color: var(--subtext1);
            margin-top: -1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group > label {
            display: block;
            color: var(--subtext0);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type='text'],
        input[type='number'],
        select {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--surface0);
            border: 1px solid var(--surface1);
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            transition: border-color 0.2s ease-in-out;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        select {
            font-size: 1rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238aadf4' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        input[type='number'] {
            -moz-appearance: textfield;
        }

        input[type='number']::-webkit-inner-spin-button,
        input[type='number']::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type='text']::placeholder,
        input[type='number']::placeholder {
            color: var(--overlay2);
        }

        input[type='text']:focus,
        input[type='number']:focus,
        select:focus {
            outline: none;
            border-color: var(--blue);
        }

        .radio-group {
            display: flex;
            background-color: var(--surface0);
            border: 1px solid var(--surface1);
            border-radius: 8px;
            padding: 4px;
            position: relative;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            flex: 1;
            padding: 0.45rem;
            text-align: center;
            color: var(--subtext0);
            font-weight: 600;
            transition-property: color;
            transition-duration: 0.2s;
            transition-timing-function: ease-in-out;
            cursor: pointer;
            border-radius: 6px;
            z-index: 2;
        }

        .glider {
            position: absolute;
            top: 4px;
            left: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px);
            background-color: var(--blue);
            border-radius: 6px;
            z-index: 1;
            transition: transform 0.3s ease-in-out;
        }

        #imperial:checked ~ .glider, #h12:checked ~ .glider {
            transform: translateX(100%);
        }

        .radio-group input[type="radio"]:checked + label {
            color: var(--crust);
        }

        button[type='submit'] {
            width: 100%;
            padding: 0.75rem 1.5rem;
            margin-top: 1.2rem;
            border: none;
            border-radius: 8px;
            background-color: var(--green);
            color: var(--crust);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        button[type='submit']:hover:not(:disabled) {
            background-color: var(--teal);
        }

        button[type='submit']:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .nav {
            display: flex;
            flex-direction: column;
            margin-bottom: 2rem;
        }

        .nav-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--surface0);
            color: var(--text);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--surface1);
            cursor: pointer;
            margin-bottom: 1rem;
            transition: background-color 0.2s ease-in-out;
            line-height: 1;
        }

        .nav-toggle:hover {
            background-color: var(--surface1);
        }

        .nav-toggle svg {
            width: 24px;
            height: 24px;
        }

        .nav-toggle .icon-close, .nav.nav-open .nav-toggle .icon-menu {
            display: none;
        }

        .nav.nav-open .nav-toggle .icon-close {
            display: block;
        }

        .nav-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-out;
        }

        .nav.nav-open .nav-links {
            max-height: 500px;
        }

        .nav-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: transparent;
            color: var(--subtext0);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: background-color 0.2s, color 0.2s;
            position: relative;
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }

        .nav-btn::before {
            content: '';
            display: inline-block;
            flex-shrink: 0;
            width: 0;
            height: 0.8em;
            background-color: transparent;
            mask-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 12'%3e%3cpath fill='black' d='M0.59 10.59L5.17 6 0.59 1.41 2 0l6 6-6 6-1.41-1.41z'/%3e%3c/svg%3e");
            mask-size: 100% 100%;
            transition: width 0.2s ease-out, margin-right 0.2s ease-out, transform 0.3s ease-out, background-color 0.2s ease-out;
        }

        .dropdown-toggle::after {
            display: none;
        }

        .nav-btn:not(.active):not(.active-parent):hover::before {
            width: 0.6em;
            margin-right: 0.6em;
            background-color: var(--mauve);
        }

        .nav-btn.active::before,
        .nav-btn.active-parent::before {
            width: 0.6em;
            margin-right: 0.6em;
            background-color: var(--blue);
        }

        .nav-dropdown.open > .dropdown-toggle::before {
            width: 0.6em;
            margin-right: 0.6em;
            transform: rotate(90deg);
            background-color: var(--text);
        }

        .nav-dropdown.open > .dropdown-toggle.active-parent::before {
            background-color: var(--blue);
        }

        .module-dropdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, margin-top 0.3s ease-out;
        }

        .module-dropdown .nav-btn {
            padding-left: 2rem;
        }

        .nav-dropdown.open > .module-dropdown {
            max-height: 200px;
            margin-top: 0.5rem;
        }

        .nav-btn.active,
        .nav-btn.active-parent {
            color: var(--blue);
            font-weight: 600;
            background-color: var(--surface0);
        }

        .nav-btn:not(.active):not(.active-parent):hover {
            color: var(--mauve);
            background-color: var(--surface0);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .add-module-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .add-module-form select {
            flex-grow: 1;
            min-width: 150px;
        }

        .add-module-form input[type='number'] {
            width: 120px;
        }

        .add-module-form button {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            background-color: var(--sapphire);
            color: var(--crust);
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .add-module-form button:hover {
            background-color: var(--blue);
        }

        #queue-list {
            list-style: none;
            padding: 0;
            min-height: 50px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            background-color: var(--surface0);
            padding: 0.75rem;
            border: 1px solid var(--surface1);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: grab;
            justify-content: space-between;
            transition: opacity 0.2s ease-in-out;
        }

        .queue-item:active {
            cursor: grabbing;
        }

        .queue-item.dragging {
            opacity: 0.4;
            background: var(--surface2);
        }

        .placeholder {
            background-color: var(--surface0);
            border: 2px dashed var(--blue);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .queue-item-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .queue-item-info svg {
            flex-shrink: 0;
        }

        .queue-item-name {
            font-weight: 500;
            color: var(--text);
        }

        .queue-item-duration {
            color: var(--subtext0);
            cursor: pointer;
        }

        .queue-item-duration-edit {
            height: 1.75em;
            width: 50px;
            padding: 1px 4px;
            font-size: 0.9em;
            text-align: center;
            background-color: var(--surface2);
            color: var(--text);
            border: 1px solid var(--blue);
            border-radius: 4px;
        }

        .queue-item-duration-edit:focus {
            outline: none;
            border-color: var(--mauve);
        }

        .queue-item-controls button {
            background: none;
            border: none;
            color: var(--subtext1);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
            line-height: 1;
        }

        .queue-item-controls button:hover {
            color: var(--mauve);
        }

        .save-btn-desktop {
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                width: 100%;
                max-width: 100%;
                min-width: 0;
                border-radius: 0;
                margin: 0;
                padding: 1.5rem 1rem;
                min-height: 100vh;
            }

            .nav {
                margin-bottom: 0;
            }
        }

        @media (min-width: 768px) {
            html,
            body {
                height: 100%;
                overflow: hidden;
                padding: 0;
            }

            .container {
                flex-direction: row;
                align-items: stretch;
                width: 100%;
                height: 100%;
                max-width: none;
                margin: 0;
                padding: 0;
                border-radius: 0;
                box-shadow: none;
                background-color: transparent;
            }

            .nav {
                justify-content: flex-start;
                width: 280px;
                flex-shrink: 0;
                background-color: var(--mantle);
                border-right: 2px solid var(--surface1);
                margin-bottom: 0;
                padding: 2rem 1rem;
                gap: 0.5rem;
            }

            .nav-toggle {
                display: none;
            }

            .nav-links {
                max-height: none;
                overflow: visible;
                flex-grow: 1;
            }

            .nav-btn {
                padding: 0.75rem 1.5rem;
            }

            .nav-btn::after {
                display: none;
            }

            .module-dropdown .nav-btn {
                padding-left: 2.7rem;
            }

            .nav-btn.active,
            .nav-btn.active-parent {
                background: var(--blue);
                color: var(--crust);
                box-shadow: none;
            }

            .nav-btn.active::before,
            .nav-btn.active-parent::before {
                background-color: var(--crust);
            }

            .save-btn-desktop {
                display: block;
                font-size: 1rem;
                font-weight: 600;
                margin-top: auto;
            }

            .save-btn-mobile {
                display: none;
            }

            .form-group {
                margin-bottom: 1.5rem;
                width: 75%;
            }

            .main-content {
                flex-grow: 1;
                padding: 3rem 4rem;
                overflow-y: auto;
                background-color: var(--base);
            }

            h1,
            p,
            h2 {
                text-align: left;
            }

            h2 {
                margin-bottom: 2.5rem;
            }

            .page-description {
                margin-top: -2rem;
            }
        }

        @media (min-width: 1200px) {
            .form-group,
            #queue-list-container {
                width: 75%;
            }
        }

        @media (min-width: 1600px) {
            .form-group,
            #queue-list-container {
                width: 50%;
            }
        }

        @media (min-width: 2000px) {
            .form-group,
            #queue-list-container {
                width: 35%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <nav class="nav">
        <button id="nav-toggle-btn" class="nav-toggle" aria-controls="nav-link-list" aria-expanded="false"
                aria-label="Toggle navigation menu">
            <svg class="icon-menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"/>
                <line x1="3" y1="6" x2="21" y2="6"/>
                <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
            <svg class="icon-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
        <div class="nav-links" id="nav-link-list">
            <button class="nav-btn active" data-page="settings">Settings</button>

            <div class="nav-dropdown">
                <button class="nav-btn dropdown-toggle" aria-haspopup="true" aria-expanded="false">
                    Modules
                </button>
                <div class="module-dropdown">
                    <button class="nav-btn" data-page="clock">Clock</button>
                    <button class="nav-btn" data-page="weather">Weather</button>
                </div>
            </div>

            <button class="nav-btn" data-page="queue">Queue</button>
            <button type='submit' form="config-form" class="save-btn-desktop">Save Settings</button>
        </div>
    </nav>
    <main class="main-content">
        <form id="config-form" action='/save_config' method='POST'>
            <div class="page active" id="settings">
                <h2>Global Settings</h2>
                <p class="page-description">
                    Configure the global settings for the display panel.
                </p>
                <div class="form-group">
                    <label>Unit System</label>
                    <div class="radio-group">
                        <input type="radio" id="metric" name="units" value="metric" checked>
                        <label for="metric">Metric</label>
                        <input type="radio" id="imperial" name="units" value="imperial">
                        <label for="imperial">Imperial</label>
                        <span class="glider"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Clock Format</label>
                    <div class="radio-group">
                        <input type="radio" id="h24" name="clock_format" value="24" checked>
                        <label for="h24">24-Hour</label>
                        <input type="radio" id="h12" name="clock_format" value="12">
                        <label for="h12">12-Hour</label>
                        <span class="glider"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="timezone_select">Timezone</label>
                    <select id="timezone_select" name="timezone"></select>
                    <input type="hidden" id="time_offset" name="time_offset">
                </div>
            </div>
            <div class="page" id="clock">
                <h2>Clock Module</h2>
                <p class="page-description">
                    The clock module displays the current time. You can customize the time format in the global
                    settings.
                </p>
            </div>
            <div class="page" id="weather">
                <h2>Weather Module</h2>
                <p class="page-description">
                    Set up the location and options for the weather module.
                </p>
                <div class="form-group">
                    <label for="weather-lat">Latitude</label>
                    <input type="number" id="weather-lat" name="weather_lat" placeholder="e.g., 51.16" step="any">
                </div>
                <div class="form-group">
                    <label for="weather-lon">Longitude</label>
                    <input type="number" id="weather-lon" name="weather_lon" placeholder="e.g., 10.45" step="any">
                </div>
                <div class="form-group">
                    <label for="weather-service">Weather Service</label>
                    <select id="weather-service" name="weather_service">
                        <option value="openmeteo">Open-Meteo</option>
                        <option value="openweathermap">OpenWeatherMap</option>
                    </select>
                </div>
                <div class="form-group" id="weather-apikey-container" style="display: none;">
                    <label for="weather-apikey">API Key</label>
                    <input type="text" id="weather-apikey" name="weather_apikey" placeholder="Enter your API Key">
                </div>
            </div>
            <div class="page" id="queue">
                <h2>Module Queue</h2>
                <p class="page-description">
                    Add modules to the display queue. Drag and drop to reorder.
                </p>
                <div class="form-group">
                    <div class="add-module-form">
                        <label for="module-select" class="visually-hidden">Select Module</label>
                        <select id="module-select">
                            <option value="clock">Clock</option>
                            <option value="weather">Weather</option>
                        </select>
                        <label for="module-duration" class="visually-hidden">Module Duration in Seconds</label>
                        <input type="number" id="module-duration" value="60" min="15" placeholder="Seconds">
                        <button type="button" id="add-module-btn">Add to Queue</button>
                    </div>
                </div>
                <div id="queue-list-container">
                    <ul id="queue-list">
                    </ul>
                </div>
                <div id="hidden-queue-inputs"></div>
            </div>

            <button type='submit' class="save-btn-mobile">Save Settings</button>
        </form>
    </main>
</div>
<script>
    const navToggle = document.getElementById('nav-toggle-btn');
    const nav = document.querySelector('.nav');
    if (navToggle && nav) {
        navToggle.addEventListener('click', () => {
            const isExpanded = navToggle.getAttribute('aria-expanded') === 'true';
            nav.classList.toggle('nav-open');
            navToggle.setAttribute('aria-expanded', !isExpanded ? 'true' : 'false');
        });
    }

    document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function (e) {
            e.stopPropagation();

            const parentDropdown = this.closest('.nav-dropdown');
            if (parentDropdown) {
                parentDropdown.classList.toggle('open');
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);
            }
        });
    });

    document.querySelectorAll('.nav-btn[data-page]').forEach(btn => {
        btn.addEventListener('click', function () {
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('active');
                b.classList.remove('active-parent');
            });

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            this.classList.add('active');
            document.getElementById(this.dataset.page).classList.add('active');

            const parentDropdown = this.closest('.nav-dropdown');
            if (parentDropdown) {
                parentDropdown.querySelector('.dropdown-toggle').classList.add('active-parent');
            }
        });
    });

    const addModuleBtn = document.getElementById('add-module-btn');
    const moduleSelect = document.getElementById('module-select');
    const moduleDurationInput = document.getElementById('module-duration');
    const queueList = document.getElementById('queue-list');
    const hiddenQueueInputsContainer = document.getElementById('hidden-queue-inputs');
    let draggedItem = null;

    function updateHiddenInputs() {
        hiddenQueueInputsContainer.innerHTML = '';
        const items = queueList.querySelectorAll('.queue-item');

        items.forEach((item, index) => {
            const moduleInput = document.createElement('input');
            moduleInput.type = 'hidden';
            moduleInput.name = `q_m_${index}`;
            moduleInput.value = item.dataset.module;
            hiddenQueueInputsContainer.appendChild(moduleInput);

            const durationInput = document.createElement('input');
            durationInput.type = 'hidden';
            durationInput.name = `q_d_${index}`;
            durationInput.value = item.dataset.duration;
            hiddenQueueInputsContainer.appendChild(durationInput);
        });
    }

    function createQueueItem(module, duration) {
        const listItem = document.createElement('li');
        listItem.className = 'queue-item';
        listItem.draggable = true;
        listItem.dataset.module = module;
        listItem.dataset.duration = duration;

        const moduleText = moduleSelect.querySelector(`option[value="${module}"]`).textContent;

        listItem.innerHTML = `
            <div class="queue-item-info">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="color: var(--overlay2);"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>
                <span class="queue-item-name">${moduleText}</span>
                <span class="queue-item-duration">${duration} sec</span>
            </div>
            <div class="queue-item-controls">
                <button type="button" class="remove-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
        `;
        return listItem;
    }

    addModuleBtn.addEventListener('click', () => {
        const module = moduleSelect.value;
        const duration = moduleDurationInput.value;
        if (duration && duration > 0) {
            const newItem = createQueueItem(module, duration);
            queueList.appendChild(newItem);
            updateHiddenInputs();
        }
    });

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.queue-item:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return {offset: offset, element: child};
            } else {
                return closest;
            }
        }, {offset: Number.NEGATIVE_INFINITY}).element;
    }

    queueList.addEventListener('click', e => {
        const removeBtn = e.target.closest('.remove-btn');
        if (removeBtn) {
            removeBtn.closest('.queue-item').remove();
            updateHiddenInputs();
            return;
        }

        const durationSpan = e.target.closest('.queue-item-duration');
        if (durationSpan) {
            const listItem = durationSpan.closest('.queue-item');
            if (listItem.querySelector('.queue-item-duration-edit')) return;

            const currentDuration = listItem.dataset.duration;

            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'queue-item-duration-edit';
            input.value = currentDuration;
            input.min = '1';

            const saveChanges = () => {
                const newDuration = input.value.trim();
                const newDurationNum = parseInt(newDuration, 10);

                if (!isNaN(newDurationNum) && newDurationNum > 0) {
                    listItem.dataset.duration = newDurationNum.toString();
                    const newSpan = document.createElement('span');
                    newSpan.className = 'queue-item-duration';
                    newSpan.textContent = `${newDurationNum} sec`;
                    input.replaceWith(newSpan);
                    updateHiddenInputs();
                } else {
                    input.replaceWith(durationSpan);
                }
            };

            input.addEventListener('blur', saveChanges);
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') {
                    input.blur();
                } else if (ev.key === 'Escape') {
                    input.replaceWith(durationSpan);
                }
            });

            durationSpan.replaceWith(input);
            input.focus();
            input.select();
        }
    });

    queueList.addEventListener('dragstart', e => {
        if (e.target && e.target.classList.contains('queue-item')) {
            draggedItem = e.target;
            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        }
    });

    queueList.addEventListener('dragend', () => {
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
            document.querySelector('.placeholder')?.remove();
            draggedItem = null;
            updateHiddenInputs();
        }
    });

    queueList.addEventListener('dragover', e => {
        e.preventDefault();
        if (!draggedItem) return;

        const afterElement = getDragAfterElement(queueList, e.clientY);

        if (afterElement === draggedItem.nextElementSibling) {
            document.querySelector('.placeholder')?.remove();
            return;
        }

        const placeholder = document.querySelector('.placeholder') || document.createElement('li');

        if (!placeholder.classList.contains('placeholder')) {
            placeholder.className = 'placeholder';
            placeholder.style.height = `${draggedItem.offsetHeight}px`;
        }

        if (afterElement == null) {
            queueList.appendChild(placeholder);
        } else {
            queueList.insertBefore(placeholder, afterElement);
        }
    });

    queueList.addEventListener('drop', e => {
        e.preventDefault();
        const placeholder = document.querySelector('.placeholder');
        if (placeholder && draggedItem) {
            placeholder.parentNode.insertBefore(draggedItem, placeholder);
        }
    });

    const serviceSelect = document.getElementById('weather-service');
    const apiKeyContainer = document.getElementById('weather-apikey-container');

    serviceSelect.addEventListener('change', function () {
        if (this.value === 'openweathermap') {
            apiKeyContainer.style.display = 'block';
        } else {
            apiKeyContainer.style.display = 'none';
        }
    });

    const timezoneSelect = document.getElementById('timezone_select');
    const timeOffsetInput = document.getElementById('time_offset');

    if (timezoneSelect && timeOffsetInput) {
        function getGmtString(timeZone) {
            try {
                const formatter = new Intl.DateTimeFormat('en', {timeZone, timeZoneName: 'longOffset'});
                const parts = formatter.formatToParts(new Date());
                return parts.find(part => part.type === 'timeZoneName')?.value || 'GMT';
            } catch (e) {
                return 'GMT';
            }
        }

        const timezones = Intl.supportedValuesOf('timeZone');
        const timezoneData = timezones.map(tz => {
            const gmtString = getGmtString(tz);
            const match = gmtString.match(/GMT([+-])(\d+)(?::(\d+))?/);
            let offsetSeconds = 0;
            if (match) {
                const sign = match[1] === '-' ? -1 : 1;
                const hours = parseInt(match[2], 10);
                const minutes = match[3] ? parseInt(match[3], 10) : 0;
                offsetSeconds = sign * (hours * 3600 + minutes * 60);
            }
            return {
                name: tz,
                offset: offsetSeconds,
                label: `(${gmtString.replace('GMT', 'UTC')}) ${tz.replace(/_/g, ' ')}`
            };
        }).sort((a, b) => a.offset - b.offset || a.name.localeCompare(b.name));

        timezoneData.forEach(tzInfo => {
            const option = document.createElement('option');
            option.value = tzInfo.name;
            option.textContent = tzInfo.label;
            option.dataset.offset = tzInfo.offset;
            timezoneSelect.appendChild(option);
        });

        function updateHiddenTimeOffset() {
            const selectedOption = timezoneSelect.options[timezoneSelect.selectedIndex];
            if (selectedOption) {
                timeOffsetInput.value = selectedOption.dataset.offset;
            }
        }

        timezoneSelect.addEventListener('change', updateHiddenTimeOffset);
    }

    function populateForm(cfg) {
        if (cfg.settings) {
            const timezoneSelect = document.getElementById('timezone_select');
            const timeOffsetHiddenInput = document.getElementById('time_offset');

            if (cfg.settings.hasOwnProperty('timezone') && cfg.settings.timezone) {
                const savedTimezone = cfg.settings.timezone;
                const optionToSelect = Array.from(timezoneSelect.options).find(opt => opt.value === savedTimezone);

                if (optionToSelect) {
                    optionToSelect.selected = true;
                }
            } else if (cfg.settings.hasOwnProperty('time_offset')) {
                const offsetInSeconds = parseInt(cfg.settings.time_offset, 10);
                const optionToSelect = Array.from(timezoneSelect.options).find(opt => parseInt(opt.dataset.offset, 10) === offsetInSeconds);
                if (optionToSelect) {
                    optionToSelect.selected = true;
                }
            } else {
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const userOption = Array.from(timezoneSelect.options).find(opt => opt.value === userTimezone);
                if (userOption) {
                    userOption.selected = true;
                }
            }

            const selectedOption = timezoneSelect.options[timezoneSelect.selectedIndex];
            if (selectedOption) {
                timeOffsetHiddenInput.value = selectedOption.dataset.offset;
            }

            if (cfg.settings.hasOwnProperty('clock_format')) {
                document.getElementById('h12').checked = (cfg.settings.clock_format === '12');
                document.getElementById('h24').checked = (cfg.settings.clock_format !== '12');
            }

            const fieldMappings = {
                'weather_lat': 'weather-lat',
                'weather_lon': 'weather-lon',
                'weather_apikey': 'weather-apikey'
            };

            for (const key in fieldMappings) {
                if (cfg.settings.hasOwnProperty(key)) {
                    const elementId = fieldMappings[key];
                    const element = document.getElementById(elementId);
                    if (element) {
                        cfg.settings[key] === 0
                            ? element.value = ""
                            : element.value = cfg.settings[key];
                    }
                }
            }

            if (cfg.settings.units) {
                document.getElementById('imperial').checked = (cfg.settings.units === 'imperial');
                document.getElementById('metric').checked = (cfg.settings.units !== 'imperial');
            }

            if (cfg.settings.hasOwnProperty('weather_service')) {
                const serviceSelect = document.getElementById('weather-service');
                if (serviceSelect) {
                    serviceSelect.value = cfg.settings.weather_service;
                    serviceSelect.dispatchEvent(new Event('change'));
                }
            }
        }

        if (cfg.queue && Array.isArray(cfg.queue)) {
            queueList.innerHTML = '';
            cfg.queue.forEach(item => {
                const newItem = createQueueItem(item.module, item.duration);
                queueList.appendChild(newItem);
            });
            updateHiddenInputs();
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Fetch and populate the initial configuration
        fetch('/get_config')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(populateForm)
            .catch(error => console.error('Error loading config:', error));

        const configForm = document.getElementById('config-form');
        const saveButtons = document.querySelectorAll('.save-btn-desktop, .save-btn-mobile');

        configForm.addEventListener('submit', function (event) {
            event.preventDefault();

            saveButtons.forEach(btn => {
                btn.disabled = true;
                btn.textContent = 'Saving...';
            });

            const formData = new FormData(configForm);

            fetch('/save_config', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error || 'Unknown server error');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Configuration saved successfully:', data);
                    saveButtons.forEach(btn => {
                        btn.style.backgroundColor = 'var(--blue)';
                        btn.textContent = '✓ Saved!';
                        setTimeout(() => {
                            btn.style.backgroundColor = '';
                            btn.textContent = 'Save Settings';
                            btn.disabled = false;
                            btn.blur();
                        }, 3500);
                    });
                })
                .catch(error => {
                    console.error('Error saving configuration:', error);
                    alert(`Error saving settings: ${error.message}`);
                    saveButtons.forEach(btn => {
                        btn.style.backgroundColor = 'var(--red)';
                        btn.textContent = 'Save Failed';
                        setTimeout(() => {
                            btn.style.backgroundColor = '';
                            btn.textContent = 'Save Settings';
                            btn.disabled = false;
                            btn.blur();
                        }, 5500);
                    });
                });
        });
    });
</script>
</body>
</html>